#!/bin/sh

BT_TRACKER=${BT_TRACKER:-true}
BT_TRACKER_URL=${BT_TRACKER_URL:-https://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_best.txt}

if [ "$BT_TRACKER" = "false" ]; then
	exit 0
fi

wget --spider "$BT_TRACKER_URL" 2>/dev/null

if [ $? -ne 0 ]; then
	echo "$(date +'%Y-%m-%d %H:%M:%S') bt-tracker-updater: URL unavailable [$BT_TRACKER_URL]"
	exit 1
fi

list="$(wget -qO- "$BT_TRACKER_URL" | awk NF | sed ':a;N;s/\n/,/g;ta')"

uuid="$(cat /proc/sys/kernel/random/uuid)"

if [ -n "$SECRET_FILE" ] && [ -r "$SECRET_FILE" ]; then
	token="$(cat "$SECRET_FILE")"
elif [ -n "$SECRET" ]; then
	token="$SECRET"
fi

json='{"jsonrpc":"2.0","id":"'$uuid'","method":"aria2.changeGlobalOption","params":["token:'$token'",{"bt-tracker":"'$list'"}]}'

# attempt to detect if the user chooses to use rpc-secure instead of using a reverse proxy
if [ -n "$(grep ^rpc-secure=true /config/aria2.conf)" ]; then
	scheme="https"
else
	scheme="http"
fi

curl --silent --insecure --header "Content-type: application/json" --data "$json" "${scheme}://localhost:6800/jsonrpc" >/dev/null 2>&1

exitcode=$?
if [ $exitcode -eq 0 ]; then
	echo "$(date +'%Y-%m-%d %H:%M:%S') bt-tracker-updater: Successfull"
	exit 0
else
	echo "$(date +'%Y-%m-%d %H:%M:%S') bt-tracker-updater: Error [$exitcode]"
	exit 1
fi
